
<!DOCTYPE html>
<html>
<head>
	<title>HeartSpark AED Heatmap</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="libs/Leaflet/leaflet.css" />
</head>
<body>
	<p style="color:#333; font-family:Arial, 'Liberation Sans', 'DejaVu Sans', sans-serif;">Heatmap of nearest 400 public defibrillators, based on your location</p>
	<div id="map" style="width: 600px; height: 400px"></div>

	<script src="libs/Leaflet/leaflet.js"></script>
	<script src="libs/jquery-2.0.3.min.js"></script>
	<script src="libs/leaflet-heat.js"></script>
	<script>

		var baseLayer = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-i86knfo3'
		});
		
		var heatLayer = L.heatLayer([], {radius: 40});
		
		var map = L.map('map', {
			layers: [baseLayer, heatLayer]
		}).setView([38.902631, -77.036570], 13);

		var app = {
			heatmapPoints: [],

			init: function(){
				var self = this;
				// init with D.C position.
				var userPosition = {lat: 38.902631, lng:-77.036570};
				app.getLocation();

				this.getData(userPosition).then(function(data){
					app._updateHeatMap(data);
				});
			},

			_updateHeatMap: function(data){
					var latlngs = this.formatData(data);
					heatLayer.setLatLngs(latlngs);
			},

      getLocation: function () {
	    	var options = {
				  enableHighAccuracy: true,
				  timeout: 5000,
				  maximumAge: 0
				};
        if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(app.success, app.error, options);
        } else {
              alert("Your browser doesn't support geolocation.") // because alerts are annoying
        }

      },

      error: function (positionError) {
      	console.log('error', positionError);
         // maybe use a div to inject some error message?
      },

      success: function(position) {
      	console.log(position);
        var userPosition = { lat: position.coords.latitude, lng:  position.coords.longitude };
        map.setView([position.coords.latitude, position.coords.longitude],12);
        app.getData(userPosition).then(function(data) {
            console.log('data', data);
            app._updateHeatMap(data);
        });
      },

			// userPosition can either be an obj with lat lng, or an obj with 
			// bounds as minLat, maxLat, etc... 
			getData: function(userPosition){
				var params = userPosition;
				params.format = 'json';
				
				return $.ajax('http://heartsparkapp.org/server/getaeds.php',{
					data: params
				});
			},

			formatData: function(aedArray){
				this.heatmapPoints = [];
				for(var  i =0; i< aedArray.length; i++){

					// If we want we could create Leaflet 
					// new L.LatLng(aedArray[i].lat, aedArray[i].lng);
					var aed = aedArray[i];
					var point = [parseFloat(aed.lat), parseFloat(aed.lng)]; 
					this.heatmapPoints.push(point);
				}
				return this.heatmapPoints;
			},
			
			setRadius: function(radius) {
				heatLayer.setOptions({radius: radius});
			},
		};

		app.init();


	</script>
</body>
</html>
