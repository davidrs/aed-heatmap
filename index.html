
<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Quick Start Guide Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="libs/Leaflet/leaflet.css" />
</head>
<body>
	<div id="map" style="width: 600px; height: 400px"></div>

	<script src="libs/Leaflet/leaflet.js"></script>
	<script src="libs/jquery-2.0.3.min.js"></script>
	<script src="libs/leaflet-heat.js"></script>
	<script>


		var map = L.map('map').setView([38.89, -77.02], 13);
		var baseLayer = L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
			maxZoom: 18,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
				'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
				'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			id: 'examples.map-i86knfo3'
		});
		
		var heatLayer = L.heatLayer([], {radius: 40});
		
		var map = L.map('map', {
			layers: [baseLayer, heatLayer]
		}).setView([38.902631, -77.036570], 13);

                L.circle([51.508, -0.11], 500, {
			color: 'red',
			fillColor: '#f03',
			fillOpacity: 0.5
		}).addTo(map).bindPopup("I am a circle.");

		var app = {
			heatmapPoints: [],

			init: function(){
				var self = this;
				// TODO: get user position via html5 geolocation

				var userPosition = {lat: 38.902631, lng:-77.036570};

				this.getData(userPosition).then(function(data){
					
					var latlngs = self.formatData(data);
					heatLayer.setLatLngs(latlngs);

				});
			},

                        getLocation: function () {
                                if (navigator.geolocation) {
                                      navigator.geolocation.getCurrentPosition(success, error);
                                } else {
                                      alert("get a better browser!") // because alerts are annoying
                                }

                        },

                        error: function () {
                           // maybe use a div to inject some error message?
                        },

                        success: function() {
                          var userPosition = { lat: 35, lng: -77 };
                          this.getData(userPosition).then(function(data) {
                              console.log('data', data);
                              //TODO: more JavaScript Sorcery...
                          });
                        },

			// userPosition can either be an obj with lat lng, or an obj with 
			// bounds as minLat, maxLat, etc... 
			getData: function(userPosition){
				var params = userPosition;
				params.format = 'json';
				
				return $.ajax('http://heartsparkapp.org/server/getaeds.php',{
					data: params
				});
			},

			formatData: function(aedArray){
				this.heatmapPoints = [];
				for(var  i =0; i< aedArray.length; i++){

					// If we want we could create Leaflet 
					// new L.LatLng(aedArray[i].lat, aedArray[i].lng);
					var aed = aedArray[i];
					var point = [parseFloat(aed.lat), parseFloat(aed.lng)]; 
					this.heatmapPoints.push(point);
				}
				return this.heatmapPoints;
			},
			
			setRadius: function(radius) {
				heatLayer.setOptions({radius: radius});
			},
		};

		app.init();


	</script>
</body>
</html>
